<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Data Debug Tool</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Database Data Debug Tool</h1>

    <div class="section">
        <h2>User ID (from Auth)</h2>
        <div id="user-info"></div>
    </div>

    <div class="section">
        <h2>Cycle Data Analysis</h2>
        <button onclick="fetchCycleData()">Fetch Cycle Data</button>
        <div id="cycle-data"></div>
    </div>

    <div class="section">
        <h2>Raw Progress Records</h2>
        <button onclick="fetchRawData()">Fetch Raw Data</button>
        <div id="raw-data"></div>
    </div>

    <div class="section">
        <h2>Stats API Response</h2>
        <button onclick="fetchStatsAPI()">Fetch Stats API</button>
        <div id="stats-data"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm';

        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseAnonKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        window.supabase = supabase;
        let userId = null;

        async function init() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error || !user) {
                document.getElementById('user-info').innerHTML = '<p class="error">Not logged in. Please log in first.</p>';
                return;
            }
            userId = user.id;
            window.userId = userId;
            document.getElementById('user-info').innerHTML = `<p class="success">User ID: ${userId}</p>`;
        }

        window.fetchCycleData = async function() {
            if (!userId) {
                alert('Please log in first');
                return;
            }

            try {
                const response = await fetch(`/api/debug-cycles?userId=${userId}`);
                const data = await response.json();
                document.getElementById('cycle-data').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('cycle-data').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        };

        window.fetchRawData = async function() {
            if (!userId) {
                alert('Please log in first');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_learning_progress')
                    .select('*')
                    .eq('user_id', userId)
                    .order('cycle_number', { ascending: true })
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Group by cycle
                const byCycle = {};
                data.forEach(record => {
                    const cycle = record.cycle_number || 1;
                    if (!byCycle[cycle]) byCycle[cycle] = [];
                    byCycle[cycle].push(record);
                });

                let html = '<h3>Records by Cycle</h3>';
                Object.keys(byCycle).sort((a, b) => a - b).forEach(cycle => {
                    const records = byCycle[cycle];
                    const completed = records.filter(r => r.is_completed).length;
                    const totalAnswers = records.reduce((sum, r) => sum + (r.answer_count || 0), 0);
                    const correctAnswers = records.reduce((sum, r) => sum + (r.correct_count || 0), 0);

                    html += `
                        <div style="margin: 20px 0; padding: 10px; border: 1px solid #ddd;">
                            <h4>Cycle ${cycle} (${records.length} records)</h4>
                            <p>Completed: ${completed} / ${records.length}</p>
                            <p>Total Answers: ${totalAnswers}</p>
                            <p>Correct Answers: ${correctAnswers}</p>
                            <details>
                                <summary>Show Records</summary>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Module</th>
                                            <th>Section</th>
                                            <th>Completed</th>
                                            <th>Correct</th>
                                            <th>Answer Count</th>
                                            <th>Correct Count</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${records.map(r => `
                                            <tr>
                                                <td>${r.module_name}</td>
                                                <td>${r.section_key}</td>
                                                <td>${r.is_completed ? '✓' : '✗'}</td>
                                                <td>${r.is_correct ? '✓' : '✗'}</td>
                                                <td>${r.answer_count || 0}</td>
                                                <td>${r.correct_count || 0}</td>
                                                <td>${new Date(r.created_at).toLocaleString()}</td>
                                                <td>${new Date(r.updated_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </details>
                        </div>
                    `;
                });

                document.getElementById('raw-data').innerHTML = html;
            } catch (error) {
                document.getElementById('raw-data').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        };

        window.fetchStatsAPI = async function() {
            if (!userId) {
                alert('Please log in first');
                return;
            }

            try {
                const response = await fetch(`/api/learning-progress/reset?userId=${userId}&action=stats`);
                const data = await response.json();
                document.getElementById('stats-data').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('stats-data').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        };

        init();
    </script>
</body>
</html>
